name: PR Quality Gates

on:
  pull_request:
    branches: [ main, develop ]

env:
  GO_VERSION: '1.21.x'

jobs:
  # Validate PR title follows conventional commit format
  pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
            build
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.

  # Check for required labels
  pr-labels:
    name: Check Required Labels
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Check for labels
        uses: mheap/github-action-required-labels@v5
        with:
          mode: minimum
          count: 1
          labels: "bug, enhancement, documentation, dependencies, performance, security, breaking-change"
          add_comment: true

  # Check PR size
  pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;

            console.log(`PR has ${additions} additions and ${deletions} deletions (total: ${totalChanges} changes)`);

            // Get list of changed files to check for lock files
            // Use pagination to handle PRs with more than 100 changed files
            let allFiles = [];
            let page = 1;
            let hasMore = true;

            while (hasMore) {
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                per_page: 100,
                page: page
              });

              allFiles = allFiles.concat(files);

              if (files.length < 100) {
                hasMore = false;
              } else {
                page++;
                // Safety limit to prevent infinite loops
                if (page > 50) {
                  console.log(`Warning: PR has more than 5000 files, stopping pagination`);
                  hasMore = false;
                }
              }
            }

            console.log(`Fetched ${allFiles.length} files across ${page} page(s)`);
            const files = allFiles;

            // Calculate changes excluding lock files and generated files
            const excludePatterns = [
              /package-lock\.json$/,
              /yarn\.lock$/,
              /pnpm-lock\.yaml$/,
              /go\.sum$/,
              /\.lock$/
            ];

            let excludedChanges = 0;
            for (const file of files) {
              if (excludePatterns.some(pattern => pattern.test(file.filename))) {
                excludedChanges += file.additions + file.deletions;
                console.log(`Excluding ${file.filename}: ${file.additions + file.deletions} lines`);
              }
            }

            const effectiveChanges = totalChanges - excludedChanges;
            console.log(`Effective changes (excluding lock files): ${effectiveChanges}`);

            // Warning for large PRs (>1000 lines changed)
            if (effectiveChanges > 1000) {
              core.warning(`⚠️  This PR modifies ${effectiveChanges} lines (excluding lock files). Consider breaking it into smaller PRs for easier review.`);
            }

            // Fail for extremely large PRs (>5000 lines) unless it's infrastructure/documentation/new-app
            const isExempt = pr.title.includes('infrastructure') ||
                            pr.title.includes('docs') ||
                            pr.title.includes('new app') ||
                            pr.labels.some(l => l.name === 'new-feature');

            if (effectiveChanges > 5000 && !isExempt) {
              core.setFailed(`❌ This PR is too large (${effectiveChanges} lines excluding lock files). Please break it into smaller, focused PRs.`);
            }

  # Check for breaking changes
  breaking-changes:
    name: Check for Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for breaking changes in commit messages
        run: |
          # Check if any commit has BREAKING CHANGE in the body
          if git log origin/${{ github.base_ref }}..HEAD --grep="BREAKING CHANGE" --oneline | grep -q "BREAKING CHANGE"; then
            echo "⚠️  WARNING: This PR contains breaking changes!"
            echo "Please ensure:"
            echo "  1. Documentation is updated"
            echo "  2. Migration guide is provided"
            echo "  3. Version bump is appropriate (major version)"

            # Check if PR has breaking-change label
            if ! gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name' | grep -q "breaking-change"; then
              echo "❌ Breaking changes detected but 'breaking-change' label is missing!"
              exit 1
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Check dependencies (requires Dependency Graph to be enabled in repo settings)
  # To enable: Settings → Security & Analysis → Enable Dependency Graph
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'main'
    # Continue on error - Dependency Graph may not be enabled in repo settings
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, LGPL-2.0

  # Check for TODO comments
  todo-check:
    name: Check TODO Comments
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for TODO comments
        run: |
          # Find all TODO comments in Go files
          TODOS=$(grep -rn "TODO\|FIXME\|HACK\|XXX" --include="*.go" . || true)

          if [ -n "$TODOS" ]; then
            echo "⚠️  Found TODO/FIXME comments in the codebase:"
            echo "$TODOS"
            echo ""
            echo "Please ensure these are tracked as GitHub issues."

            # Count TODOs
            TODO_COUNT=$(echo "$TODOS" | wc -l)
            if [ $TODO_COUNT -gt 10 ]; then
              echo "⚠️  Warning: More than 10 TODO comments found. Consider addressing some before merging."
            fi
          fi

  # Verify no debug code
  debug-check:
    name: Check for Debug Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for debug statements
        run: |
          # Check for common debug patterns (excluding cmd/ since those are CLIs)
          DEBUG_PATTERNS=$(grep -rn "fmt.Println\|log.Println\|print(\|println(" --include="*.go" internal/ pkg/ 2>/dev/null | grep -v "_test.go" || true)

          if [ -n "$DEBUG_PATTERNS" ]; then
            echo "❌ Found debug print statements in library code:"
            echo "$DEBUG_PATTERNS"
            echo ""
            echo "Please remove debug statements or use proper logging (zerolog)."
            exit 1
          fi

          echo "✅ No debug statements found in library code"

  # Check documentation
  docs-check:
    name: Check Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      - name: Check if documentation needs update
        run: |
          # Get list of changed files
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD || echo "")

          # Check if significant Go files changed
          GO_FILES=$(echo "$FILES_CHANGED" | grep "\.go$" | grep -v "_test.go" || true)

          if [ -n "$GO_FILES" ]; then
            # Check if any documentation was updated
            DOCS_UPDATED=$(echo "$FILES_CHANGED" | grep -E "README\.md|docs/.*\.md|CLAUDE\.md" || true)

            if [ -z "$DOCS_UPDATED" ]; then
              echo "⚠️  Warning: Go code was modified but no documentation was updated."
              echo "Consider updating:"
              echo "  - README.md (for user-facing changes)"
              echo "  - CLAUDE.md (for architecture changes)"
              echo "  - docs/ (for detailed documentation)"
            else
              echo "✅ Documentation was updated"
            fi
          fi

  # Test coverage diff
  coverage-diff:
    name: Coverage Diff
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Start CI services
        run: |
          docker compose -f docker/ci/docker-compose.yml up -d --build --wait
          echo "Services started successfully"

      - name: Verify services are ready
        run: |
          echo "Verifying PostgreSQL..."
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "PostgreSQL is unavailable - sleeping"
            sleep 2
          done
          echo "PostgreSQL is up"

          echo "Verifying Redis..."
          until nc -z localhost 6379; do
            echo "Redis is unavailable - sleeping"
            sleep 2
          done
          echo "Redis is up"

      - name: Setup database extensions
        env:
          PGPASSWORD: postgres
        run: |
          psql -h localhost -U postgres -d cryptofunk_test -c "CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;"
          psql -h localhost -U postgres -d cryptofunk_test -c "CREATE EXTENSION IF NOT EXISTS vector;"

      - name: Run database migrations
        env:
          DATABASE_URL: "postgres://postgres:postgres@localhost:5432/cryptofunk_test?sslmode=disable"
        run: |
          go run cmd/migrate/main.go up

      - name: Run tests with coverage
        env:
          DATABASE_URL: "postgres://postgres:postgres@localhost:5432/cryptofunk_test?sslmode=disable"
          REDIS_URL: "localhost:6379"
          NATS_URL: "nats://localhost:4222"
        run: |
          go test -coverprofile=coverage-new.out -covermode=atomic ./...
          # Extract coverage percentage BEFORE switching branches (files must exist)
          NEW_COVERAGE=$(go tool cover -func=coverage-new.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "NEW_COVERAGE=${NEW_COVERAGE}" >> $GITHUB_ENV
          echo "PR branch coverage: ${NEW_COVERAGE}%"

      - name: Get base branch coverage
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}
          go test -coverprofile=coverage-base.out -covermode=atomic ./... || echo "Base coverage not available"
          if [ -f coverage-base.out ]; then
            BASE_COVERAGE=$(go tool cover -func=coverage-base.out | grep total | awk '{print $3}' | sed 's/%//')
            echo "BASE_COVERAGE=${BASE_COVERAGE}" >> $GITHUB_ENV
            echo "Base branch coverage: ${BASE_COVERAGE}%"
          fi
        env:
          DATABASE_URL: "postgres://postgres:postgres@localhost:5432/cryptofunk_test?sslmode=disable"
          REDIS_URL: "localhost:6379"
        continue-on-error: true

      - name: Compare coverage
        run: |
          if [ -n "$BASE_COVERAGE" ] && [ -n "$NEW_COVERAGE" ]; then
            echo "Base coverage: ${BASE_COVERAGE}%"
            echo "New coverage: ${NEW_COVERAGE}%"

            DIFF=$(echo "$NEW_COVERAGE - $BASE_COVERAGE" | bc)
            echo "Coverage diff: ${DIFF}%"

            # Fail if coverage decreased by more than 1%
            if (( $(echo "$DIFF < -1" | bc -l) )); then
              echo "❌ Coverage decreased by ${DIFF}%. Please add tests for new code."
              exit 1
            elif (( $(echo "$DIFF > 0" | bc -l) )); then
              echo "✅ Coverage increased by ${DIFF}%!"
            else
              echo "✅ Coverage maintained"
            fi
          else
            echo "⚠️  Base coverage not available, skipping comparison"
          fi

      - name: Stop CI services
        if: always()
        run: |
          docker compose -f docker/ci/docker-compose.yml down -v

  # All checks must pass
  all-checks:
    name: All PR Checks Passed
    runs-on: ubuntu-latest
    needs: [pr-title, pr-size, debug-check, coverage-diff]
    if: always()
    steps:
      - name: Check all jobs
        uses: actions/github-script@v7
        with:
          script: |
            const needs = ${{ toJSON(needs) }};
            const failures = Object.values(needs).filter(job => job.result === 'failure');

            if (failures.length > 0) {
              core.setFailed(`${failures.length} required check(s) failed`);
            } else {
              core.info('✅ All PR quality checks passed!');
            }
